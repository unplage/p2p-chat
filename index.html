<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>P2P Secure Chat</title>
    <style>
        :root { --primary: #07C160; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; height: 100dvh; overflow: hidden; position: fixed; width: 100%; }
        
        .container { display: flex; height: 100%; flex-direction: column; }
        
        /* Header */
        .header { background: #2e2e2e; color: white; padding: 12px 16px; padding-top: max(12px, var(--safe-top)); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 16px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; background: #666; }
        .status-badge.connected { background: var(--primary); }
        .header-actions { display: flex; gap: 12px; }
        .icon-btn { width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.1); color: white; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .icon-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .icon-btn.active { background: var(--primary); }
        
        /* Messages */
        .messages { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 20px; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; gap: 12px; }
        .message { display: flex; gap: 8px; max-width: 85%; animation: pop 0.3s; }
        @keyframes pop { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.sent { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 36px; height: 36px; border-radius: 6px; background: #999; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; flex-shrink: 0; }
        .message.sent .msg-avatar { background: var(--primary); }
        .msg-content { background: white; padding: 10px 14px; border-radius: 18px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-break: break-word; font-size: 15px; line-height: 1.4; }
        .message.sent .msg-content { background: #95EC69; border-bottom-right-radius: 4px; }
        .message.received .msg-content { border-bottom-left-radius: 4px; }
        .msg-time { font-size: 10px; color: #999; margin-top: 4px; text-align: right; }
        .system-msg { align-self: center; background: rgba(0,0,0,0.05); color: #666; padding: 6px 12px; border-radius: 12px; font-size: 12px; max-width: 90%; text-align: center; }
        
        /* Images in chat */
        .msg-image { max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer; display: block; }
        
        /* Input Area */
        .input-area { background: #f7f7f7; border-top: 1px solid #e0e0e0; padding: 10px 12px; padding-bottom: max(10px, var(--safe-bottom)); }
        .input-toolbar { display: flex; gap: 12px; margin-bottom: 8px; align-items: center; }
        .tool-btn { width: 32px; height: 32px; border: none; background: transparent; font-size: 20px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
        .tool-btn input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .input-box { display: flex; gap: 8px; align-items: flex-end; background: white; border-radius: 20px; padding: 8px 12px; border: 1px solid #e0e0e0; }
        .msg-input { flex: 1; border: none; outline: none; font-size: 16px; max-height: 100px; resize: none; font-family: inherit; padding: 4px; line-height: 1.4; background: transparent; }
        .send-btn { background: var(--primary); color: white; border: none; padding: 6px 16px; border-radius: 16px; font-size: 14px; cursor: pointer; font-weight: 500; }
        .send-btn:disabled { background: #ccc; }
        
        /* Video Call Overlay */
        .call-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; }
        .call-overlay.active { display: flex; }
        .remote-video { flex: 1; background: #111; object-fit: cover; }
        .local-pip { position: absolute; top: max(60px, var(--safe-top)); right: 16px; width: 100px; height: 140px; background: #333; border-radius: 12px; overflow: hidden; border: 2px solid rgba(255,255,255,0.3); }
        .local-pip video { width: 100%; height: 100%; object-fit: cover; }
        .call-controls { position: absolute; bottom: max(40px, var(--safe-bottom)); left: 50%; transform: translateX(-50%); display: flex; gap: 24px; background: rgba(0,0,0,0.6); padding: 16px 24px; border-radius: 40px; backdrop-filter: blur(10px); }
        .call-btn { width: 56px; height: 56px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transition: transform 0.2s; }
        .call-btn:active { transform: scale(0.95); }
        .call-btn.hangup { background: #ff4d4f; }
        .call-btn.mute { background: rgba(255,255,255,0.2); }
        .call-btn.muted { background: #ff4d4f; }
        
        /* Connection Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; overflow: hidden; animation: slideUp 0.3s; display: flex; flex-direction: column; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { background: #2e2e2e; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn:disabled { opacity: 0.5; }
        
        .step-indicator { display: flex; justify-content: center; margin-bottom: 20px; gap: 30px; }
        .step { text-align: center; color: #ccc; font-size: 12px; }
        .step.active { color: var(--primary); font-weight: bold; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: bold; }
        .step.active .step-circle { background: var(--primary); color: white; }
        
        textarea.code-input { width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 8px; padding: 12px; font-family: monospace; font-size: 13px; resize: none; margin: 10px 0; background: #f8f8f8; }
        .copy-btn-group { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .copy-btn { flex: 1; min-width: 100px; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .copy-btn.secondary { background: #f0f0f0; color: #333; }
        
        /* Network Status Warning */
        .net-warning { position: fixed; top: max(60px, var(--safe-top)); left: 50%; transform: translateX(-50%); background: #ff4d4f; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; z-index: 500; display: none; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .net-warning.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -10px); } to { opacity: 1; transform: translate(-50%, 0); } }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }
        .text-red { color: #ff4d4f; }
        .text-green { color: var(--primary); }
        
        @media (min-height: 600px) {
            .modal-content { max-height: 80vh; border-radius: 12px; width: 90%; max-width: 500px; margin: auto; animation: fadeIn 0.2s; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-title">
            <span>P2PåŠ å¯†é€šä¿¡</span>
            <span class="status-badge" id="connBadge">æœªè¿æ¥</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="callBtn" onclick="startCall('video')" disabled title="è§†é¢‘é€šè¯">ğŸ“¹</button>
            <button class="icon-btn" id="voiceBtn" onclick="startCall('audio')" disabled title="è¯­éŸ³é€šè¯">ğŸ“</button>
            <button class="icon-btn" onclick="showConnModal()" title="è¿æ¥è®¾ç½®">âš™ï¸</button>
        </div>
    </div>

    <div class="messages" id="messages">
        <div class="system-msg">ğŸ”’ ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡å·¥å…·<br>æ•°æ®ä¸ç»è¿‡æœåŠ¡å™¨ï¼Œç›´æ¥ç‚¹å¯¹ç‚¹ä¼ è¾“</div>
        <div class="system-msg">ç‚¹å‡»å³ä¸Šè§’ âš™ï¸ åˆ›å»ºæˆ–åŠ å…¥è¿æ¥</div>
    </div>

    <div class="input-area">
        <div class="input-toolbar">
            <button class="tool-btn">
                ğŸ“·
                <input type="file" accept="image/*" onchange="handleImageSelect(this)" capture="environment">
            </button>
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()">
                ğŸ–¼ï¸
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImageSelect(this)">
            </button>
        </div>
        <div class="input-box">
            <textarea class="msg-input" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" oninput="autoResize(this)" onkeypress="handleEnter(event)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendText()" disabled>å‘é€</button>
        </div>
    </div>
</div>

<!-- Network Warning -->
<div class="net-warning" id="netWarning">âš ï¸ è¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨é‡è¿...</div>

<!-- Call Overlay -->
<div class="call-overlay" id="callOverlay">
    <video class="remote-video" id="remoteVideo" autoplay playsinline></video>
    <div class="local-pip">
        <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div class="call-controls">
        <button class="call-btn mute" id="muteBtn" onclick="toggleMute()">ğŸ¤</button>
        <button class="call-btn hangup" onclick="endCall()">ğŸ“</button>
    </div>
</div>

<!-- Connection Modal -->
<div class="modal" id="connModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="font-size: 16px; font-weight: 500;">å»ºç«‹P2Pè¿æ¥</h3>
            <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:20px;">âœ•</button>
        </div>
        
        <div class="modal-body">
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div>äº¤æ¢ä»£ç </div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div>å®Œæˆ</div>
                </div>
            </div>

            <div id="modeSelect">
                <p class="text-center mb-10" style="color:#666; font-size:14px;">é€‰æ‹©è§’è‰²å¼€å§‹å»ºç«‹åŠ å¯†è¿æ¥</p>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-primary" onclick="setMode('create')" style="flex:1; padding:20px;">
                        <div style="font-size:24px; margin-bottom:8px;">ğŸš€</div>
                        <div>åˆ›å»ºè¿æ¥<br><small style="opacity:0.8;">æˆ‘æ˜¯å‘èµ·æ–¹</small></div>
                    </button>
                    <button class="btn btn-secondary" onclick="setMode('join')" style="flex:1; padding:20px;">
                        <div style="font-size:24px; margin-bottom:8px;">ğŸ”—</div>
                        <div>åŠ å…¥è¿æ¥<br><small style="opacity:0.6;">æˆ‘æ˜¯æ¥æ”¶æ–¹</small></div>
                    </button>
                </div>
            </div>

            <div id="createFlow" class="hidden">
                <div id="createStep1">
                    <p style="font-size:13px; color:#666; margin-bottom:10px;">
                        1. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆè¿æ¥ç <br>
                        2. <span class="text-red">é•¿æŒ‰å¤åˆ¶</span>ç”Ÿæˆçš„ä»£ç <br>
                        3. é€šè¿‡å¾®ä¿¡/çŸ­ä¿¡å‘é€ç»™å¯¹æ–¹<br>
                        4. ç­‰å¾…å¯¹æ–¹å‘å›å“åº”ç 
                    </p>
                    <button class="btn btn-primary" onclick="createOffer()" id="createBtn" style="width:100%; margin:10px 0;">
                        ç”Ÿæˆè¿æ¥ç 
                    </button>
                    <textarea class="code-input" id="offerCode" readonly placeholder="ç”Ÿæˆåå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                    <div class="copy-btn-group">
                        <button class="copy-btn" onclick="copyText('offerCode')">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                        <button class="copy-btn secondary" onclick="goToCreateStep2()">ä¸‹ä¸€æ­¥ â†’</button>
                    </div>
                </div>
                
                <div id="createStep2" class="hidden">
                    <p style="font-size:13px; color:#666; margin-bottom:10px;">
                        å°†å¯¹æ–¹å‘å›çš„<span class="text-green">å“åº”ç </span>ç²˜è´´åˆ°ä¸‹æ–¹ï¼š
                    </p>
                    <textarea class="code-input" id="answerCode" placeholder="ç²˜è´´å“åº”ç ..."></textarea>
                    <button class="btn btn-primary" onclick="completeConnection()" style="width:100%; margin-top:10px;">
                        å®Œæˆè¿æ¥
                    </button>
                    <button class="btn btn-secondary" onclick="backToCreateStep1()" style="width:100%; margin-top:8px;">
                        â† è¿”å›ä¸Šä¸€æ­¥
                    </button>
                </div>
            </div>

            <div id="joinFlow" class="hidden">
                <div id="joinStep1">
                    <p style="font-size:13px; color:#666; margin-bottom:10px;">
                        å°†å¯¹æ–¹å‘é€çš„<span class="text-green">è¿æ¥ç </span>ç²˜è´´åˆ°ä¸‹æ–¹ï¼š
                    </p>
                    <textarea class="code-input" id="joinOffer" placeholder="ç²˜è´´è¿æ¥ç ..."></textarea>
                    <button class="btn btn-primary" onclick="createAnswer()" style="width:100%; margin-top:10px;">
                        ç”Ÿæˆå“åº”ç 
                    </button>
                </div>
                
                <div id="joinStep2" class="hidden">
                    <p style="font-size:13px; color:#666; margin-bottom:10px;">
                        1. <span class="text-red">é•¿æŒ‰å¤åˆ¶</span>ä¸‹æ–¹å“åº”ç <br>
                        2. å‘é€ç»™å¯¹æ–¹<br>
                        3. ç­‰å¾…å¯¹æ–¹å®Œæˆè¿æ¥
                    </p>
                    <textarea class="code-input" id="joinAnswer" readonly></textarea>
                    <button class="copy-btn" onclick="copyText('joinAnswer')" style="width:100%; margin-top:10px;">
                        ğŸ“‹ å¤åˆ¶å“åº”ç 
                    </button>
                    <div class="system-msg mt-10" style="background:#e6f7ed; color:#07C160;">
                        å‘é€åè¯·ç­‰å¾…å¯¹æ–¹ç‚¹å‡»"å®Œæˆè¿æ¥"ï¼Œ<br>æ­¤é¡µé¢ä¿æŒæ‰“å¼€ä¸è¦å…³é—­
                    </div>
                </div>
            </div>

            <div id="successView" class="hidden text-center" style="padding:30px 0;">
                <div style="font-size:48px; margin-bottom:10px;">âœ…</div>
                <h3 style="color:var(--primary); margin-bottom:8px;">è¿æ¥æˆåŠŸï¼</h3>
                <p style="color:#666; font-size:13px;">å¯ä»¥å¼€å§‹åŠ å¯†é€šä¿¡äº†</p>
                <button class="btn btn-primary" onclick="closeModal()" style="width:100%; margin-top:20px;">å¼€å§‹èŠå¤©</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============== é…ç½® ==============
const iceConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        {
            urls: 'turn:openrelay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        },
        {
            urls: 'turn:openrelay.metered.ca:443',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        }
    ],
    iceCandidatePoolSize: 10
};

// ============== å…¨å±€çŠ¶æ€ ==============
let pc = null;
let dc = null;
let localStream = null;
let remoteStream = null;
let currentMode = null;
let isConnected = false;
let isInCall = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨é€šè¯ä¸­
let callSenders = []; // å­˜å‚¨é€šè¯æœŸé—´æ·»åŠ çš„sendersï¼Œç”¨äºç»“æŸåæ¸…ç†
let pendingCandidates = [];

// ============== åˆå§‹åŒ– ==============
function init() {
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && pc && pc.connectionState === 'disconnected') {
            showNetWarning(true);
        }
    });
}

function showConnModal() {
    document.getElementById('connModal').classList.add('active');
    resetModal();
}

function closeModal() {
    document.getElementById('connModal').classList.remove('active');
}

function resetModal() {
    document.getElementById('modeSelect').classList.remove('hidden');
    document.getElementById('createFlow').classList.add('hidden');
    document.getElementById('joinFlow').classList.add('hidden');
    document.getElementById('successView').classList.add('hidden');
    document.getElementById('createStep1').classList.remove('hidden');
    document.getElementById('createStep2').classList.add('hidden');
    document.getElementById('joinStep1').classList.remove('hidden');
    document.getElementById('joinStep2').classList.add('hidden');
    updateStep(1);
}

function setMode(mode) {
    currentMode = mode;
    document.getElementById('modeSelect').classList.add('hidden');
    if (mode === 'create') {
        document.getElementById('createFlow').classList.remove('hidden');
    } else {
        document.getElementById('joinFlow').classList.remove('hidden');
    }
}

function updateStep(step) {
    document.getElementById('step1').classList.toggle('active', step === 1);
    document.getElementById('step2').classList.toggle('active', step === 2);
}

// ============== WebRTCæ ¸å¿ƒ ==============
function createPeer() {
    pc = new RTCPeerConnection(iceConfig);
    
    pc.onconnectionstatechange = () => {
        console.log('è¿æ¥çŠ¶æ€:', pc.connectionState);
        const badge = document.getElementById('connBadge');
        
        if (pc.connectionState === 'connected') {
            badge.textContent = 'å·²åŠ å¯†';
            badge.classList.add('connected');
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('callBtn').disabled = false;
            document.getElementById('voiceBtn').disabled = false;
            showNetWarning(false);
            if (!isConnected) {
                isConnected = true;
                addSystemMsg('ğŸ”’ ç«¯åˆ°ç«¯åŠ å¯†è¿æ¥å·²å»ºç«‹');
            }
        } else if (['disconnected', 'failed', 'closed'].includes(pc.connectionState)) {
            badge.textContent = 'å·²æ–­å¼€';
            badge.classList.remove('connected');
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('callBtn').disabled = true;
            document.getElementById('voiceBtn').disabled = true;
            if (isConnected) {
                isConnected = false;
                addSystemMsg('âš ï¸ è¿æ¥å·²æ–­å¼€');
            }
        }
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) {
            console.log('ICEå€™é€‰:', e.candidate);
        }
    };

    pc.ondatachannel = (e) => {
        setupDataChannel(e.channel);
    };

    pc.ontrack = (e) => {
        console.log('æ”¶åˆ°è¿œç¨‹è½¨é“:', e.track.kind);
        remoteStream = e.streams[0];
        const remoteVideo = document.getElementById('remoteVideo');
        if (remoteVideo.srcObject !== remoteStream) {
            remoteVideo.srcObject = remoteStream;
        }
    };
    
    // å…³é”®ï¼šç›‘å¬é‡æ–°åå•†äº‹ä»¶
    pc.onnegotiationneeded = async () => {
        console.log('éœ€è¦é‡æ–°åå•†');
        // å¦‚æœæ­£åœ¨é€šè¯ä¸­ï¼Œç”±å‘èµ·æ–¹å¤„ç†é‡æ–°åå•†
        if (isInCall && currentMode === 'create') {
            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await waitForIceComplete();
                dc.send(JSON.stringify({
                    type: 'renegotiate',
                    sdp: btoa(JSON.stringify(pc.localDescription))
                }));
            } catch (err) {
                console.error('é‡æ–°åå•†å¤±è´¥:', err);
            }
        }
    };
    
    return pc;
}

// åˆ›å»ºOfferï¼ˆå‘èµ·æ–¹ï¼‰
async function createOffer() {
    createPeer();
    
    dc = pc.createDataChannel('chat', { ordered: true, maxRetransmits: 3 });
    setupDataChannel(dc);
    
    try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await waitForIceComplete();
        
        const code = btoa(JSON.stringify(pc.localDescription));
        document.getElementById('offerCode').value = code;
        
        setTimeout(() => {
            document.getElementById('offerCode').select();
        }, 100);
        
    } catch (err) {
        alert('ç”Ÿæˆå¤±è´¥: ' + err.message);
    }
}

// åˆ›å»ºAnswerï¼ˆæ¥æ”¶æ–¹ï¼‰
async function createAnswer() {
    const offerStr = document.getElementById('joinOffer').value.trim();
    if (!offerStr) return alert('è¯·è¾“å…¥è¿æ¥ç ');
    
    createPeer();
    
    try {
        const offer = JSON.parse(atob(offerStr));
        await pc.setRemoteDescription(offer);
        
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await waitForIceComplete();
        
        const code = btoa(JSON.stringify(pc.localDescription));
        document.getElementById('joinAnswer').value = code;
        
        document.getElementById('joinStep1').classList.add('hidden');
        document.getElementById('joinStep2').classList.remove('hidden');
        updateStep(2);
        
        setTimeout(() => {
            document.getElementById('joinAnswer').select();
        }, 100);
        
        checkConnectionStatus();
        
    } catch (err) {
        alert('æ— æ•ˆè¿æ¥ç : ' + err.message);
    }
}

// å®Œæˆè¿æ¥ï¼ˆå‘èµ·æ–¹è¾“å…¥Answerï¼‰
async function completeConnection() {
    const answerStr = document.getElementById('answerCode').value.trim();
    if (!answerStr) return alert('è¯·è¾“å…¥å“åº”ç ');
    
    try {
        const answer = JSON.parse(atob(answerStr));
        await pc.setRemoteDescription(answer);
        await waitForConnection();
        
        document.getElementById('successView').classList.remove('hidden');
        document.getElementById('createStep2').classList.add('hidden');
        updateStep(2);
        
    } catch (err) {
        alert('è¿æ¥å¤±è´¥: ' + err.message);
    }
}

function waitForIceComplete() {
    return new Promise((resolve) => {
        if (pc.iceGatheringState === 'complete') return resolve();
        const check = () => {
            if (pc.iceGatheringState === 'complete') {
                pc.removeEventListener('icegatheringstatechange', check);
                resolve();
            }
        };
        pc.addEventListener('icegatheringstatechange', check);
        setTimeout(resolve, 2000);
    });
}

function waitForConnection() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const check = setInterval(() => {
            if (pc.connectionState === 'connected') {
                clearInterval(check);
                resolve();
            } else if (++attempts > 20) {
                clearInterval(check);
                reject(new Error('è¿æ¥è¶…æ—¶'));
            }
        }, 500);
    });
}

function checkConnectionStatus() {
    const interval = setInterval(() => {
        if (pc.connectionState === 'connected') {
            clearInterval(interval);
            isConnected = true;
            addSystemMsg('ğŸ”’ è¿æ¥å·²å»ºç«‹ï¼');
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('callBtn').disabled = false;
            document.getElementById('voiceBtn').disabled = false;
            document.getElementById('connBadge').textContent = 'å·²åŠ å¯†';
            document.getElementById('connBadge').classList.add('connected');
        }
    }, 1000);
}

function setupDataChannel(channel) {
    dc = channel;
    
    channel.onopen = () => {
        console.log('DataChannelå·²æ‰“å¼€');
        isConnected = true;
    };
    
    channel.onclose = () => {
        console.log('DataChannelå·²å…³é—­');
        isConnected = false;
    };
    
    channel.onerror = (e) => {
        console.error('DataChannelé”™è¯¯:', e);
    };
    
    channel.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);
            if (data.type === 'renegotiate') {
                // å¤„ç†é‡æ–°åå•†
                handleRenegotiate(data);
            } else {
                handleIncomingData(data);
            }
        } catch (err) {
            console.error('æ¶ˆæ¯è§£æå¤±è´¥:', err);
        }
    };
}

async function handleRenegotiate(data) {
    try {
        const desc = JSON.parse(atob(data.sdp));
        await pc.setRemoteDescription(desc);
        if (desc.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            dc.send(JSON.stringify({
                type: 'renegotiate-answer',
                sdp: btoa(JSON.stringify(answer))
            }));
        }
    } catch (err) {
        console.error('é‡æ–°åå•†å¤„ç†å¤±è´¥:', err);
    }
}

// ============== æ¶ˆæ¯å¤„ç† ==============
function handleIncomingData(data) {
    if (data.type === 'text') {
        addMsg('å¯¹æ–¹', data.content, 'received');
    } else if (data.type === 'image') {
        addImage('å¯¹æ–¹', data.content, 'received');
    } else if (data.type === 'call-offer') {
        handleCallOffer(data);
    } else if (data.type === 'call-answer') {
        handleCallAnswer(data);
    } else if (data.type === 'call-end') {
        endCall();
    } else if (data.type === 'renegotiate-answer') {
        handleRenegotiateAnswer(data);
    }
}

async function handleRenegotiateAnswer(data) {
    try {
        const desc = JSON.parse(atob(data.sdp));
        await pc.setRemoteDescription(desc);
    } catch (err) {
        console.error('å¤„ç†é‡åå•†åº”ç­”å¤±è´¥:', err);
    }
}

function sendText() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text || !dc || dc.readyState !== 'open') return;
    
    dc.send(JSON.stringify({ type: 'text', content: text }));
    addMsg('æˆ‘', text, 'sent');
    input.value = '';
    input.style.height = 'auto';
}

async function handleImageSelect(input) {
    const file = input.files[0];
    if (!file || !dc || dc.readyState !== 'open') {
        if (!dc || dc.readyState !== 'open') alert('è¯·å…ˆå»ºç«‹è¿æ¥');
        return;
    }
    
    if (file.size > 2 * 1024 * 1024) {
        alert('å›¾ç‰‡è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº2MBçš„å›¾ç‰‡');
        return;
    }
    
    try {
        const compressed = await compressImage(file, 800, 0.7);
        dc.send(JSON.stringify({ type: 'image', content: compressed }));
        addImage('æˆ‘', compressed, 'sent');
    } catch (err) {
        alert('å‘é€å¤±è´¥: ' + err.message);
    }
    
    input.value = '';
}

function compressImage(file, maxWidth, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// ============== éŸ³è§†é¢‘é€šè¯ï¼ˆä¿®å¤å¤šæ¬¡é€šè¯é—®é¢˜ï¼‰=============

async function startCall(type) {
    if (!pc || !isConnected) {
        alert('è¯·å…ˆå»ºç«‹P2Pè¿æ¥');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²åœ¨é€šè¯ä¸­
    if (isInCall) {
        alert('æ­£åœ¨è¿›è¡Œé€šè¯ï¼Œè¯·å…ˆç»“æŸå½“å‰é€šè¯');
        return;
    }
    
    try {
        // 1. è·å–åª’ä½“æµ
        const constraints = type === 'video' ? { video: true, audio: true } : { video: false, audio: true };
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // 2. æ˜¾ç¤ºæœ¬åœ°è§†é¢‘
        document.getElementById('localVideo').srcObject = localStream;
        
        // 3. é‡ç½®å‘é€å™¨æ•°ç»„
        callSenders = [];
        
        // 4. æ·»åŠ è½¨é“åˆ°PeerConnectionå¹¶è®°å½•sender
        localStream.getTracks().forEach(track => {
            const sender = pc.addTrack(track, localStream);
            callSenders.push(sender);
            console.log('æ·»åŠ è½¨é“:', track.kind, 'Sender:', sender);
        });
        
        // 5. åˆ›å»ºOfferå¹¶å‘é€
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await waitForIceComplete();
        
        dc.send(JSON.stringify({
            type: 'call-offer',
            sdp: btoa(JSON.stringify(pc.localDescription)),
            callType: type
        }));
        
        // 6. æ ‡è®°é€šè¯çŠ¶æ€å¹¶æ˜¾ç¤ºUI
        isInCall = true;
        showCallUI();
        addSystemMsg(type === 'video' ? 'ğŸ“¹ è§†é¢‘é€šè¯å¼€å§‹' : 'ğŸ“ è¯­éŸ³é€šè¯å¼€å§‹');
        
    } catch (err) {
        // æ¸…ç†å¤±è´¥çš„èµ„æº
        cleanupLocalStream();
        if (err.name === 'NotAllowedError') {
            alert('è¯·å…è®¸æ‘„åƒå¤´/éº¦å…‹é£æƒé™');
        } else {
            alert('å¯åŠ¨å¤±è´¥: ' + err.message);
        }
    }
}

async function handleCallOffer(data) {
    const accept = confirm(`æ”¶åˆ°${data.callType === 'video' ? 'è§†é¢‘' : 'è¯­éŸ³'}é€šè¯è¯·æ±‚ï¼Œæ˜¯å¦æ¥å¬ï¼Ÿ`);
    
    if (!accept) {
        dc.send(JSON.stringify({ type: 'call-end' }));
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²åœ¨é€šè¯ä¸­
    if (isInCall) {
        alert('å·²æœ‰æ­£åœ¨è¿›è¡Œçš„é€šè¯');
        return;
    }
    
    try {
        // 1. å¦‚æœå·²æœ‰æœ¬åœ°æµï¼ˆå¼‚å¸¸æƒ…å†µï¼‰ï¼Œå…ˆæ¸…ç†
        if (localStream) {
            cleanupLocalStream();
        }
        
        // 2. è·å–åª’ä½“æµ
        const constraints = data.callType === 'video' ? { video: true, audio: true } : { video: false, audio: true };
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        document.getElementById('localVideo').srcObject = localStream;
        
        // 3. é‡ç½®å‘é€å™¨æ•°ç»„
        callSenders = [];
        
        // 4. æ·»åŠ è½¨é“å¹¶è®°å½•sender
        localStream.getTracks().forEach(track => {
            const sender = pc.addTrack(track, localStream);
            callSenders.push(sender);
        });
        
        // 5. å¤„ç†Offerå¹¶åˆ›å»ºAnswer
        const offer = JSON.parse(atob(data.sdp));
        await pc.setRemoteDescription(offer);
        
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await waitForIceComplete();
        
        dc.send(JSON.stringify({
            type: 'call-answer',
            sdp: btoa(JSON.stringify(answer))
        }));
        
        // 6. æ ‡è®°çŠ¶æ€å¹¶æ˜¾ç¤ºUI
        isInCall = true;
        showCallUI();
        addSystemMsg(data.callType === 'video' ? 'ğŸ“¹ æ¥å¬è§†é¢‘é€šè¯' : 'ğŸ“ æ¥å¬è¯­éŸ³é€šè¯');
        
    } catch (err) {
        cleanupLocalStream();
        alert('æ¥å¬å¤±è´¥: ' + err.message);
    }
}

async function handleCallAnswer(data) {
    try {
        const answer = JSON.parse(atob(data.sdp));
        await pc.setRemoteDescription(answer);
        console.log('é€šè¯è¿æ¥å·²å»ºç«‹');
    } catch (err) {
        console.error('å¤„ç†åº”ç­”å¤±è´¥:', err);
        // å¦‚æœå¤„ç†å¤±è´¥ï¼Œç»“æŸé€šè¯å¹¶æ¸…ç†
        endCall();
    }
}

// ========== å…³é”®ä¿®å¤ï¼šç»“æŸé€šè¯æ—¶æ­£ç¡®æ¸…ç† ==========
function endCall() {
    console.log('ç»“æŸé€šè¯ï¼Œæ¸…ç†èµ„æº...');
    
    // 1. é‡ç½®çŠ¶æ€æ ‡è®°ï¼ˆå¿…é¡»åœ¨æ¸…ç†èµ„æºå‰ï¼Œé˜²æ­¢äº‹ä»¶è§¦å‘å™¨é‡å¤æ“ä½œï¼‰
    isInCall = false;
    
    // 2. å‘é€ç»“æŸä¿¡å·ï¼ˆå¿…é¡»åœ¨æ¸…ç†å‰å‘é€ï¼‰
    if (dc && dc.readyState === 'open') {
        dc.send(JSON.stringify({ type: 'call-end' }));
    }
    
    // 3. ä»PeerConnectionä¸­ç§»é™¤æ‰€æœ‰sendersï¼ˆå…³é”®æ­¥éª¤ï¼‰
    if (pc && callSenders.length > 0) {
        callSenders.forEach(sender => {
            if (pc.getSenders().includes(sender)) {
                try {
                    pc.removeTrack(sender);
                    console.log('å·²ç§»é™¤Sender:', sender);
                } catch (e) {
                    console.log('ç§»é™¤Senderå¤±è´¥:', e);
                }
            }
        });
        callSenders = [];
    }
    
    // 4. åœæ­¢å¹¶æ¸…ç†æœ¬åœ°åª’ä½“æµ
    cleanupLocalStream();
    
    // 5. é‡ç½®è§†é¢‘å…ƒç´ 
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideo = document.getElementById('localVideo');
    
    if (remoteVideo) {
        remoteVideo.pause();
        remoteVideo.srcObject = null;
    }
    
    if (localVideo) {
        localVideo.pause();
        localVideo.srcObject = null;
    }
    
    // 6. éšè—UI
    document.getElementById('callOverlay').classList.remove('active');
    
    // 7. é‡ç½®é™éŸ³æŒ‰é’®çŠ¶æ€
    const muteBtn = document.getElementById('muteBtn');
    if (muteBtn) {
        muteBtn.classList.remove('muted');
        muteBtn.textContent = 'ğŸ¤';
    }
    
    addSystemMsg('ğŸ“´ é€šè¯å·²ç»“æŸ');
    console.log('é€šè¯èµ„æºæ¸…ç†å®Œæˆ');
}

// è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†æœ¬åœ°åª’ä½“æµ
function cleanupLocalStream() {
    if (localStream) {
        localStream.getTracks().forEach(track => {
            track.stop();
            console.log('å·²åœæ­¢è½¨é“:', track.kind);
        });
        localStream = null;
    }
}

function showCallUI() {
    document.getElementById('callOverlay').classList.add('active');
}

function toggleMute() {
    if (localStream) {
        const audio = localStream.getAudioTracks()[0];
        if (audio) {
            audio.enabled = !audio.enabled;
            const btn = document.getElementById('muteBtn');
            btn.classList.toggle('muted', !audio.enabled);
            btn.textContent = audio.enabled ? 'ğŸ¤' : 'ğŸ™ï¸âŒ';
        }
    }
}

// ============== UIè¾…åŠ© ==============
function addMsg(sender, text, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    const time = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
    div.innerHTML = `
        <div class="msg-avatar">${sender === 'æˆ‘' ? 'æˆ‘' : 'å‹'}</div>
        <div>
            <div class="msg-content">${text}</div>
            <div class="msg-time">${time}</div>
        </div>
    `;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
}

function addImage(sender, src, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    const time = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
    div.innerHTML = `
        <div class="msg-avatar">${sender === 'æˆ‘' ? 'æˆ‘' : 'å‹'}</div>
        <div>
            <div class="msg-content" style="padding:4px;"><img src="${src}" class="msg-image" onclick="window.open(this.src)"></div>
            <div class="msg-time">${time}</div>
        </div>
    `;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
}

function addSystemMsg(text) {
    const div = document.createElement('div');
    div.className = 'system-msg';
    div.innerHTML = text;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({ behavior: 'smooth' });
}

function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
}

function handleEnter(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendText();
    }
}

function copyText(id) {
    const el = document.getElementById(id);
    el.select();
    try {
        document.execCommand('copy');
        if (navigator.vibrate) navigator.vibrate(50);
        showToast('å·²å¤åˆ¶');
    } catch(e) {
        showToast('è¯·æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶');
    }
}

function showToast(msg) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed; bottom:20%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; font-size:14px; z-index:3000;';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

function showNetWarning(show) {
    document.getElementById('netWarning').classList.toggle('show', show);
}

function goToCreateStep2() {
    if (!document.getElementById('offerCode').value) {
        alert('è¯·å…ˆç”Ÿæˆè¿æ¥ç ');
        return;
    }
    document.getElementById('createStep1').classList.add('hidden');
    document.getElementById('createStep2').classList.remove('hidden');
    updateStep(2);
}

function backToCreateStep1() {
    document.getElementById('createStep2').classList.add('hidden');
    document.getElementById('createStep1').classList.remove('hidden');
    updateStep(1);
}

// å¯åŠ¨
init();
</script>
</body>
</html>
