<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>P2P Secure Chat</title>
    <style>
        :root { --primary: #07C160; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; height: 100dvh; overflow: hidden; position: fixed; width: 100%; }
        .container { display: flex; height: 100%; flex-direction: column; }
        .header { background: #2e2e2e; color: white; padding: 12px 16px; padding-top: max(12px, var(--safe-top)); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 16px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; background: #666; }
        .status-badge.connected { background: var(--primary); }
        .header-actions { display: flex; gap: 12px; }
        .icon-btn { width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.1); color: white; border-radius: 50%; font-size: 18px; cursor: pointer; }
        .icon-btn:disabled { opacity: 0.3; }
        .messages { flex: 1; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; gap: 12px; }
        .message { display: flex; gap: 8px; max-width: 85%; animation: pop 0.3s; }
        @keyframes pop { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.sent { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 36px; height: 36px; border-radius: 6px; background: #999; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; flex-shrink: 0; }
        .message.sent .msg-avatar { background: var(--primary); }
        .msg-content { background: white; padding: 10px 14px; border-radius: 18px; word-break: break-word; font-size: 15px; }
        .message.sent .msg-content { background: #95EC69; border-bottom-right-radius: 4px; }
        .message.received .msg-content { border-bottom-left-radius: 4px; }
        .msg-time { font-size: 10px; color: #999; margin-top: 4px; text-align: right; }
        .system-msg { align-self: center; background: rgba(0,0,0,0.05); color: #666; padding: 6px 12px; border-radius: 12px; font-size: 12px; max-width: 90%; text-align: center; }
        .system-msg.error { background: #fff2f0; color: #ff4d4f; border: 1px solid #ffccc7; }
        .system-msg.success { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .msg-image { max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer; }
        .input-area { background: #f7f7f7; border-top: 1px solid #e0e0e0; padding: 10px 12px; padding-bottom: max(10px, var(--safe-bottom)); }
        .input-toolbar { display: flex; gap: 12px; margin-bottom: 8px; }
        .tool-btn { width: 32px; height: 32px; border: none; background: transparent; font-size: 20px; cursor: pointer; position: relative; }
        .tool-btn input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .input-box { display: flex; gap: 8px; align-items: flex-end; background: white; border-radius: 20px; padding: 8px 12px; border: 1px solid #e0e0e0; }
        .msg-input { flex: 1; border: none; outline: none; font-size: 16px; max-height: 100px; resize: none; font-family: inherit; padding: 4px; background: transparent; }
        .send-btn { background: var(--primary); color: white; border: none; padding: 6px 16px; border-radius: 16px; font-size: 14px; cursor: pointer; }
        .send-btn:disabled { background: #ccc; }
        .call-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; }
        .call-overlay.active { display: flex; }
        .remote-video { flex: 1; background: #111; object-fit: cover; }
        .local-pip { position: absolute; top: max(60px, var(--safe-top)); right: 16px; width: 100px; height: 140px; background: #333; border-radius: 12px; overflow: hidden; border: 2px solid rgba(255,255,255,0.3); }
        .local-pip video { width: 100%; height: 100%; object-fit: cover; }
        .call-controls { position: absolute; bottom: max(40px, var(--safe-bottom)); left: 50%; transform: translateX(-50%); display: flex; gap: 24px; background: rgba(0,0,0,0.6); padding: 16px 24px; border-radius: 40px; }
        .call-btn { width: 56px; height: 56px; border-radius: 50%; border: none; font-size: 24px; color: white; cursor: pointer; }
        .call-btn.hangup { background: #ff4d4f; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; overflow: hidden; }
        .modal-header { background: #2e2e2e; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        textarea.code-input { width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 8px; padding: 12px; font-family: monospace; font-size: 13px; resize: none; margin: 10px 0; background: #f8f8f8; }
        .copy-btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .copy-btn { flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; }
        .copy-btn.secondary { background: #f0f0f0; color: #333; }
        .step-indicator { display: flex; justify-content: center; margin-bottom: 20px; gap: 30px; }
        .step { text-align: center; color: #ccc; font-size: 12px; }
        .step.active { color: var(--primary); font-weight: bold; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-weight: bold; }
        .step.active .step-circle { background: var(--primary); color: white; }
        .help-box { background: #fffbe6; border: 1px solid #ffe58f; padding: 12px; border-radius: 8px; font-size: 13px; color: #5c4b00; margin: 10px 0; }
        .help-box ul { margin: 8px 0 0 16px; padding: 0; }
        .help-box li { margin: 4px 0; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-title">
            <span>P2PåŠ å¯†é€šä¿¡</span>
            <span class="status-badge" id="connBadge">æœªè¿æ¥</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="callBtn" onclick="startCall('video')" disabled>ğŸ“¹</button>
            <button class="icon-btn" id="voiceBtn" onclick="startCall('audio')" disabled>ğŸ“</button>
            <button class="icon-btn" onclick="showConnModal()">âš™ï¸</button>
        </div>
    </div>

    <div class="messages" id="messages">
        <div class="system-msg" id="connHint">ğŸ”’ ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡<br>æ”¯æŒä¸åŒWiFi/4G/5Gè¿æ¥</div>
    </div>

    <div class="input-area">
        <div class="input-toolbar">
            <button class="tool-btn">ğŸ“·<input type="file" accept="image/*" onchange="handleImage(this)" capture="environment"></button>
            <button class="tool-btn" onclick="document.getElementById('file').click()">ğŸ–¼ï¸<input type="file" id="file" accept="image/*" style="display:none" onchange="handleImage(this)"></button>
        </div>
        <div class="input-box">
            <textarea class="msg-input" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendText()" disabled>å‘é€</button>
        </div>
    </div>
</div>

<div class="call-overlay" id="callOverlay">
    <video class="remote-video" id="remoteVideo" autoplay playsinline></video>
    <div class="local-pip"><video id="localVideo" autoplay playsinline muted></video></div>
    <div class="call-controls">
        <button class="call-btn" style="background:rgba(255,255,255,0.2)" id="muteBtn" onclick="toggleMute()">ğŸ¤</button>
        <button class="call-btn hangup" onclick="hangup()">ğŸ“</button>
    </div>
</div>

<div class="modal" id="connModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="font-size:16px">å»ºç«‹P2Pè¿æ¥</h3>
            <button onclick="closeModal()" style="background:none;border:none;color:white;font-size:20px">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="step-indicator">
                <div class="step active" id="step1"><div class="step-circle">1</div><div>äº¤æ¢ä»£ç </div></div>
                <div class="step" id="step2"><div class="step-circle">2</div><div>å®Œæˆ</div></div>
            </div>

            <div id="modeSelect">
                <div class="help-box">
                    <strong>ğŸ’¡ è¿æ¥è¯´æ˜ï¼š</strong>
                    <ul>
                        <li><strong>ç›¸åŒWiFiï¼š</strong>ç›´æ¥è¿æ¥ï¼Œæœ€å¿«æœ€ç¨³å®š</li>
                        <li><strong>ä¸åŒWiFi/4Gï¼š</strong>ä¾èµ–TURNæœåŠ¡å™¨ä¸­è½¬ï¼Œå¯èƒ½å¤±è´¥</li>
                        <li>å¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨ç›¸åŒWiFiç½‘ç»œ</li>
                    </ul>
                </div>
                <div style="display:flex;gap:10px;margin-top:20px">
                    <button class="btn btn-primary" onclick="setMode('create')" style="flex:1;padding:20px">
                        <div style="font-size:24px;margin-bottom:8px">ğŸš€</div>
                        <div>åˆ›å»ºè¿æ¥</div>
                    </button>
                    <button class="btn btn-secondary" onclick="setMode('join')" style="flex:1;padding:20px">
                        <div style="font-size:24px;margin-bottom:8px">ğŸ”—</div>
                        <div>åŠ å…¥è¿æ¥</div>
                    </button>
                </div>
            </div>

            <div id="createFlow" class="hidden">
                <div id="createStep1">
                    <p style="font-size:13px;color:#666;margin-bottom:10px">1. ç”Ÿæˆè¿æ¥ç ï¼ˆçº¦éœ€3ç§’æ”¶é›†ICEå€™é€‰ï¼‰</p>
                    <button class="btn btn-primary" onclick="createOffer()" style="width:100%;margin:10px 0">ç”Ÿæˆè¿æ¥ç </button>
                    <textarea class="code-input" id="offerCode" readonly placeholder="ç”Ÿæˆåå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                    <div class="copy-btn-group">
                        <button class="copy-btn" onclick="copy('offerCode')">ğŸ“‹ å¤åˆ¶</button>
                        <button class="copy-btn secondary" onclick="goStep(2)">ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>
                <div id="createStep2" class="hidden">
                    <p style="font-size:13px;color:#666;margin-bottom:10px">2. ç²˜è´´å¯¹æ–¹çš„å“åº”ç ï¼š</p>
                    <textarea class="code-input" id="answerCode" placeholder="ç²˜è´´å“åº”ç ..."></textarea>
                    <button class="btn btn-primary" onclick="completeConnection()" style="width:100%;margin-top:10px">å®Œæˆè¿æ¥</button>
                    <button class="btn btn-secondary" onclick="goStep(1)" style="width:100%;margin-top:8px">è¿”å›</button>
                </div>
            </div>

            <div id="joinFlow" class="hidden">
                <div id="joinStep1">
                    <p style="font-size:13px;color:#666;margin-bottom:10px">ç²˜è´´å¯¹æ–¹çš„è¿æ¥ç ï¼š</p>
                    <textarea class="code-input" id="joinOffer" placeholder="ç²˜è´´è¿æ¥ç ..."></textarea>
                    <button class="btn btn-primary" onclick="createAnswer()" style="width:100%;margin-top:10px">ç”Ÿæˆå“åº”ç </button>
                </div>
                <div id="joinStep2" class="hidden">
                    <p style="font-size:13px;color:#666;margin-bottom:10px">å¤åˆ¶å“åº”ç å‘ç»™å¯¹æ–¹ï¼š</p>
                    <textarea class="code-input" id="joinAnswer" readonly></textarea>
                    <button class="copy-btn" onclick="copy('joinAnswer')" style="width:100%;margin-top:10px">ğŸ“‹ å¤åˆ¶å“åº”ç </button>
                    <div class="system-msg" style="background:#e6f7ed;color:#07C160;margin-top:10px">ç­‰å¾…å¯¹æ–¹å®Œæˆè¿æ¥...</div>
                </div>
            </div>

            <div id="successView" class="hidden text-center" style="padding:30px 0">
                <div style="font-size:48px;margin-bottom:10px">âœ…</div>
                <h3 style="color:var(--primary);margin-bottom:8px">è¿æ¥æˆåŠŸï¼</h3>
                <button class="btn btn-primary" onclick="closeModal()" style="width:100%;margin-top:20px">å¼€å§‹èŠå¤©</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== ICE é…ç½®ï¼ˆæœ€å¤§å…¼å®¹æ€§ï¼‰====================
// é…ç½®äº†å¤šä¸ª STUN + TURN æœåŠ¡å™¨ï¼Œæé«˜è·¨ç½‘ç»œæˆåŠŸç‡
const iceConfig = {
    iceServers: [
        // Google STUN
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        
        // Open Relay TURNï¼ˆæœ€å¸¸ç”¨çš„å…è´¹TURNï¼‰
        {
            urls: [
                'turn:openrelay.metered.ca:80',
                'turn:openrelay.metered.ca:443',
                'turn:openrelay.metered.ca:443?transport=tcp',
                'turns:openrelay.metered.ca:443'
            ],
            username: 'openrelayproject',
            credential: 'openrelayproject'
        },
        
        // å¤‡ç”¨ TURN 1
        {
            urls: 'turn:18.235.113.106:3478',
            username: 'freeuser',
            credential: 'freepassword'
        },
        
        // å¤‡ç”¨ TURN 2ï¼ˆå¦‚æœä¸Šé¢çš„éƒ½å¤±æ•ˆï¼‰
        {
            urls: 'turn:relay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        }
    ],
    iceCandidatePoolSize: 10,
    // å…³é”®ï¼šå¼ºåˆ¶ä½¿ç”¨relayå€™é€‰ï¼ˆå¦‚æœç›´æ¥è¿æ¥å¤±è´¥ï¼‰
    iceTransportPolicy: 'all'
};

let pc = null;
let dc = null;
let localStream = null;
let isConnected = false;
let isInCall = false;
let callSenders = [];
let lastEndTime = 0;
let endMsgSent = false;

function addLog(msg, type='system') {
    console.log(msg);
    const div = document.createElement('div');
    div.className = `system-msg ${type}`;
    div.style.fontSize = '11px';
    div.textContent = msg;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
}

function showConnModal() {
    document.getElementById('connModal').classList.add('active');
    resetModal();
}

function closeModal() {
    document.getElementById('connModal').classList.remove('active');
}

function resetModal() {
    document.getElementById('modeSelect').classList.remove('hidden');
    document.getElementById('createFlow').classList.add('hidden');
    document.getElementById('joinFlow').classList.add('hidden');
    document.getElementById('successView').classList.add('hidden');
    document.getElementById('createStep1').classList.remove('hidden');
    document.getElementById('createStep2').classList.add('hidden');
    document.getElementById('joinStep1').classList.remove('hidden');
    document.getElementById('joinStep2').classList.add('hidden');
    updateStep(1);
}

function setMode(mode) {
    document.getElementById('modeSelect').classList.add('hidden');
    if (mode === 'create') {
        document.getElementById('createFlow').classList.remove('hidden');
    } else {
        document.getElementById('joinFlow').classList.remove('hidden');
    }
}

function updateStep(step) {
    document.getElementById('step1').classList.toggle('active', step === 1);
    document.getElementById('step2').classList.toggle('active', step === 2);
}

function goStep(step) {
    if (step === 2 && !document.getElementById('offerCode').value) {
        alert('è¯·å…ˆç”Ÿæˆè¿æ¥ç ');
        return;
    }
    document.getElementById('createStep1').classList.toggle('hidden', step !== 1);
    document.getElementById('createStep2').classList.toggle('hidden', step !== 2);
}

function createPeer() {
    addLog('æ­£åœ¨åˆ›å»ºPeerConnection...');
    pc = new RTCPeerConnection(iceConfig);
    
    // ç›‘æ§ICEæ”¶é›†çŠ¶æ€
    pc.onicegatheringstatechange = () => {
        addLog('ICEæ”¶é›†çŠ¶æ€: ' + pc.iceGatheringState);
    };
    
    // ç›‘æ§ICEå€™é€‰
    let candidateCount = 0;
    pc.onicecandidate = (e) => {
        if (e.candidate) {
            candidateCount++;
            const type = e.candidate.candidate.includes('typ relay') ? 'TURN' : 
                        e.candidate.candidate.includes('typ srflx') ? 'STUN' : 'HOST';
            console.log(`ICEå€™é€‰ #${candidateCount}: ${type}`);
        } else {
            addLog(`ICEæ”¶é›†å®Œæˆï¼Œå…±${candidateCount}ä¸ªå€™é€‰`, 'success');
        }
    };
    
    // ç›‘æ§è¿æ¥çŠ¶æ€ï¼ˆå…³é”®ï¼šè¯Šæ–­ä¿¡æ¯ï¼‰
    pc.onconnectionstatechange = () => {
        addLog('è¿æ¥çŠ¶æ€: ' + pc.connectionState);
        const badge = document.getElementById('connBadge');
        
        if (pc.connectionState === 'connected') {
            badge.textContent = 'å·²åŠ å¯†';
            badge.classList.add('connected');
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('callBtn').disabled = false;
            document.getElementById('voiceBtn').disabled = false;
            if (!isConnected) {
                isConnected = true;
                addLog('âœ… ç«¯åˆ°ç«¯åŠ å¯†è¿æ¥å·²å»ºç«‹', 'success');
                // æ˜¾ç¤ºä½¿ç”¨çš„å€™é€‰ç±»å‹
                pc.getStats().then(stats => {
                    stats.forEach(report => {
                        if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                            const local = stats.get(report.localCandidateId);
                            const remote = stats.get(report.remoteCandidateId);
                            console.log('ä½¿ç”¨å€™é€‰:', local?.candidateType, '->', remote?.candidateType);
                            if (local?.candidateType === 'relay' || remote?.candidateType === 'relay') {
                                addLog('é€šè¿‡TURNæœåŠ¡å™¨ä¸­ç»§è¿æ¥', 'success');
                            }
                        }
                    });
                });
            }
        } else if (pc.connectionState === 'failed') {
            badge.textContent = 'å¤±è´¥';
            badge.classList.remove('connected');
            addLog('âŒ è¿æ¥å¤±è´¥ï¼šNATç©¿è¶Šå¤±è´¥ï¼Œå»ºè®®åˆ‡æ¢è‡³ç›¸åŒWiFi', 'error');
            alert('è¿æ¥å¤±è´¥ï¼šæ— æ³•å»ºç«‹è·¨ç½‘ç»œè¿æ¥ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. åŒæ–¹é˜²ç«å¢™é˜»æ–­äº†TURNç«¯å£ï¼ˆ3478/443ï¼‰\n2. TURNæœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨\n3. ç½‘ç»œè¿è¥å•†é™åˆ¶\n\nå»ºè®®ï¼šåŒæ–¹è¿æ¥ç›¸åŒWiFiåå†è¯•');
        } else if (pc.connectionState === 'disconnected') {
            badge.textContent = 'å·²æ–­å¼€';
            badge.classList.remove('connected');
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('callBtn').disabled = true;
            document.getElementById('voiceBtn').disabled = true;
        }
    };
    
    pc.ondatachannel = (e) => {
        addLog('æ”¶åˆ°DataChannel');
        setupDC(e.channel);
    };
    
    pc.ontrack = (e) => {
        document.getElementById('remoteVideo').srcObject = e.streams[0];
    };
    
    return pc;
}

async function createOffer() {
    createPeer();
    dc = pc.createDataChannel('chat', { ordered: true });
    setupDC(dc);
    
    try {
        addLog('ç”ŸæˆOfferä¸­...');
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        // ç­‰å¾…ICEæ”¶é›†ï¼ˆå…³é”®ï¼šç¡®ä¿åŒ…å«TURNå€™é€‰ï¼‰
        addLog('ç­‰å¾…ICEå€™é€‰æ”¶é›†ï¼ˆçº¦2-3ç§’ï¼‰...');
        await waitForIceComplete();
        
        // ç”Ÿæˆä»£ç 
        const sdp = pc.localDescription.sdp;
        const code = btoa(JSON.stringify({
            type: pc.localDescription.type,
            sdp: sdp,
            // åŒ…å«æ—¶é—´æˆ³é˜²æ­¢è¿‡æœŸ
            ts: Date.now()
        }));
        
        document.getElementById('offerCode').value = code;
        addLog('è¿æ¥ç å·²ç”Ÿæˆï¼ˆé•¿åº¦:' + code.length + 'ï¼‰', 'success');
        
    } catch (err) {
        addLog('é”™è¯¯: ' + err.message, 'error');
        alert('ç”Ÿæˆå¤±è´¥: ' + err.message);
    }
}

async function createAnswer() {
    const offerStr = document.getElementById('joinOffer').value.trim();
    if (!offerStr) return alert('è¯·è¾“å…¥è¿æ¥ç ');
    
    try {
        const offerData = JSON.parse(atob(offerStr));
        
        // æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆè¶…è¿‡60ç§’å¯èƒ½è¿‡æœŸï¼‰
        if (offerData.ts && Date.now() - offerData.ts > 60000) {
            alert('è­¦å‘Šï¼šè¿æ¥ç å¯èƒ½å·²è¿‡æœŸï¼ˆè¶…è¿‡60ç§’ï¼‰ï¼Œå»ºè®®é‡æ–°ç”Ÿæˆ');
        }
        
        addLog('è§£æOfferæˆåŠŸï¼Œåˆ›å»ºPeerConnection...');
        createPeer();
        
        await pc.setRemoteDescription({type: offerData.type, sdp: offerData.sdp});
        
        addLog('ç”ŸæˆAnswerä¸­...');
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        
        addLog('ç­‰å¾…ICEå€™é€‰...');
        await waitForIceComplete();
        
        const code = btoa(JSON.stringify({
            type: pc.localDescription.type,
            sdp: pc.localDescription.sdp,
            ts: Date.now()
        }));
        
        document.getElementById('joinAnswer').value = code;
        document.getElementById('joinStep1').classList.add('hidden');
        document.getElementById('joinStep2').classList.remove('hidden');
        updateStep(2);
        
        waitForConnect();
        
    } catch (err) {
        addLog('é”™è¯¯: ' + err.message, 'error');
        alert('æ— æ•ˆè¿æ¥ç : ' + err.message);
    }
}

async function completeConnection() {
    const answerStr = document.getElementById('answerCode').value.trim();
    if (!answerStr) return alert('è¯·è¾“å…¥å“åº”ç ');
    
    try {
        // é˜²æ­¢çŠ¶æ€é”™è¯¯
        if (pc.signalingState === 'stable') {
            addLog('è¿æ¥å·²ç¨³å®š');
            showSuccess();
            return;
        }
        
        if (pc.signalingState !== 'have-local-offer') {
            addLog('é”™è¯¯ï¼šå½“å‰çŠ¶æ€ ' + pc.signalingState + 'ï¼Œæ— æ³•è®¾ç½®Answer', 'error');
            alert('è¿æ¥çŠ¶æ€é”™è¯¯ï¼š' + pc.signalingState + '\nè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
        
        const answerData = JSON.parse(atob(answerStr));
        addLog('è®¾ç½®Answerä¸­...');
        await pc.setRemoteDescription({type: answerData.type, sdp: answerData.sdp});
        showSuccess();
        
    } catch (err) {
        addLog('è¿æ¥å¤±è´¥: ' + err.message, 'error');
        alert('è¿æ¥å¤±è´¥: ' + err.message);
    }
}

function showSuccess() {
    document.getElementById('successView').classList.remove('hidden');
    document.getElementById('createStep2').classList.add('hidden');
    updateStep(2);
}

function waitForIceComplete() {
    return new Promise((resolve) => {
        if (pc.iceGatheringState === 'complete') {
            resolve();
            return;
        }
        setTimeout(() => {
            if (pc.iceGatheringState !== 'complete') {
                addLog('ICEæ”¶é›†è¶…æ—¶ï¼Œä½¿ç”¨å½“å‰å€™é€‰ç»§ç»­');
            }
            resolve();
        }, 3000);
    });
}

function waitForConnect() {
    let attempts = 0;
    const check = setInterval(() => {
        attempts++;
        if (pc.connectionState === 'connected') {
            clearInterval(check);
            document.getElementById('successView').classList.remove('hidden');
            document.getElementById('joinStep2').classList.add('hidden');
            updateStep(2);
        } else if (attempts > 20) { // 10ç§’è¶…æ—¶
            clearInterval(check);
            addLog('è¿æ¥è¶…æ—¶ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œæˆ–åˆ‡æ¢è‡³ç›¸åŒWiFi', 'error');
        }
    }, 500);
}

function setupDC(channel) {
    dc = channel;
    dc.onopen = () => {
        addLog('DataChannelå·²æ‰“å¼€', 'success');
        isConnected = true;
    };
    dc.onclose = () => {
        isConnected = false;
    };
    dc.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);
            if (data.type === 'text') addMsg('å¯¹æ–¹', data.content, 'received');
            else if (data.type === 'image') addImg('å¯¹æ–¹', data.content, 'received');
            else if (data.type === 'call-offer') handleCallOffer(data);
            else if (data.type === 'call-answer') handleCallAnswer(data);
            else if (data.type === 'call-end') handleRemoteEnd();
        } catch (err) {
            console.error(err);
        }
    };
}

function sendText() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text || !dc) return;
    dc.send(JSON.stringify({type: 'text', content: text}));
    addMsg('æˆ‘', text, 'sent');
    input.value = '';
    input.style.height = 'auto';
}

function handleImage(input) {
    const file = input.files[0];
    if (!file || !dc) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        compressImage(e.target.result, 800, 0.6).then(compressed => {
            dc.send(JSON.stringify({type: 'image', content: compressed}));
            addImg('æˆ‘', compressed, 'sent');
        });
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function compressImage(dataUrl, maxW, q) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxW) { h = (maxW/w)*h; w = maxW; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', q));
        };
        img.src = dataUrl;
    });
}

async function startCall(type) {
    if (!pc || !isConnected) return alert('è¯·å…ˆå»ºç«‹è¿æ¥');
    if (isInCall) return alert('æ­£åœ¨é€šè¯ä¸­');
    
    try {
        const cons = type === 'video' ? {video: true, audio: true} : {video: false, audio: true};
        localStream = await navigator.mediaDevices.getUserMedia(cons);
        document.getElementById('localVideo').srcObject = localStream;
        
        callSenders = [];
        localStream.getTracks().forEach(track => {
            callSenders.push(pc.addTrack(track, localStream));
        });
        
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await waitForIceComplete();
        
        dc.send(JSON.stringify({type: 'call-offer', sdp: btoa(JSON.stringify(pc.localDescription))}));
        
        endMsgSent = false;
        isInCall = true;
        document.getElementById('callOverlay').classList.add('active');
        addMsg('ç³»ç»Ÿ', type === 'video' ? 'ğŸ“¹ è§†é¢‘é€šè¯å¼€å§‹' : 'ğŸ“ è¯­éŸ³é€šè¯å¼€å§‹', 'system');
    } catch (err) {
        cleanup();
        alert('å¯åŠ¨å¤±è´¥: ' + err.message);
    }
}

async function handleCallOffer(data) {
    if (isInCall) return alert('å·²æœ‰é€šè¯');
    if (!confirm('æ”¶åˆ°é€šè¯è¯·æ±‚ï¼Œæ˜¯å¦æ¥å¬ï¼Ÿ')) {
        dc.send(JSON.stringify({type: 'call-end'}));
        return;
    }
    
    try {
        localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        document.getElementById('localVideo').srcObject = localStream;
        
        callSenders = [];
        localStream.getTracks().forEach(track => {
            callSenders.push(pc.addTrack(track, localStream));
        });
        
        await pc.setRemoteDescription(JSON.parse(atob(data.sdp)));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await waitForIceComplete();
        
        dc.send(JSON.stringify({type: 'call-answer', sdp: btoa(JSON.stringify(answer))}));
        
        endMsgSent = false;
        isInCall = true;
        document.getElementById('callOverlay').classList.add('active');
        addMsg('ç³»ç»Ÿ', 'ğŸ“ å·²æ¥å¬', 'system');
    } catch (err) {
        cleanup();
        alert('æ¥å¬å¤±è´¥');
    }
}

async function handleCallAnswer(data) {
    try {
        await pc.setRemoteDescription(JSON.parse(atob(data.sdp)));
    } catch (e) {
        console.error(e);
    }
}

function hangup() {
    if (dc) dc.send(JSON.stringify({type: 'call-end'}));
    doCleanup(false);
}

function handleRemoteEnd() {
    const now = Date.now();
    if (now - lastEndTime < 2000) return;
    lastEndTime = now;
    doCleanup(true);
}

function doCleanup(isRemote) {
    if (endMsgSent) return;
    if (!isInCall && !localStream) return;
    
    endMsgSent = true;
    isInCall = false;
    
    if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
    }
    
    if (pc && callSenders.length > 0) {
        callSenders.forEach(sender => {
            try { pc.removeTrack(sender); } catch(e) {}
        });
        callSenders = [];
    }
    
    document.getElementById('remoteVideo').srcObject = null;
    document.getElementById('localVideo').srcObject = null;
    document.getElementById('callOverlay').classList.remove('active');
    document.getElementById('muteBtn').textContent = 'ğŸ¤';
    
    addMsg('ç³»ç»Ÿ', isRemote ? 'ğŸ“´ å¯¹æ–¹å·²æŒ‚æ–­' : 'ğŸ“´ é€šè¯å·²ç»“æŸ', 'system');
    
    setTimeout(() => { endMsgSent = false; }, 1000);
}

function toggleMute() {
    if (!localStream) return;
    const audio = localStream.getAudioTracks()[0];
    if (audio) {
        audio.enabled = !audio.enabled;
        const btn = document.getElementById('muteBtn');
        btn.textContent = audio.enabled ? 'ğŸ¤' : 'ğŸ™ï¸';
    }
}

function addMsg(sender, text, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    const time = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
    div.innerHTML = `
        <div class="msg-avatar">${sender === 'æˆ‘' ? 'æˆ‘' : sender === 'ç³»ç»Ÿ' ? 'ç³»' : 'å‹'}</div>
        <div>
            <div class="msg-content">${text}</div>
            <div class="msg-time">${time}</div>
        </div>
    `;
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
}

function addImg(sender, src, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    const time = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
    div.innerHTML = `
        <div class="msg-avatar">${sender === 'æˆ‘' ? 'æˆ‘' : 'å‹'}</div>
        <div>
            <div class="msg-content" style="padding:4px"><img src="${src}" class="msg-image" onclick="window.open(this.src)"></div>
            <div class="msg-time">${time}</div>
        </div>
    `;
    document.getElementById('messages').appendChild(div);
}

function copy(id) {
    const el = document.getElementById(id);
    el.select();
    document.execCommand('copy');
    if (navigator.vibrate) navigator.vibrate(50);
}

function init() {}
init();
</script>
</body>
</html>
